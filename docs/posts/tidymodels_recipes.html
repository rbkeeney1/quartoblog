<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ryan Keeney">

<title>Ryan Keeney - Preprocessing data in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Preprocessing data in R</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../" class="sidebar-logo-link">
      <img src="../headshot.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Ryan Keeney</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://twitter.com/rbkeeney" title="" class="sidebar-tool px-1"><i class="bi bi-twitter"></i></a>
    <a href="https://www.linkedin.com/in/ryan-brent-keeney/" title="" class="sidebar-tool px-1"><i class="bi bi-linkedin"></i></a>
    <a href="mailto:keeney.ryan@gmail.com" title="" class="sidebar-tool px-1"><i class="bi bi-envelope"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">About Ryan</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../helpful_links.html" class="sidebar-item-text sidebar-link">Resources and Links</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Data Prep</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/tidymodels_recipes.html" class="sidebar-item-text sidebar-link active">Preprocessing data in R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/missing_data.html" class="sidebar-item-text sidebar-link">Missing Data</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Supervised Learning</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/anova_introduction.html" class="sidebar-item-text sidebar-link">ANOVA 101</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Unsupervised Learning</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/PCA_eu_food.html" class="sidebar-item-text sidebar-link">PCA with EU Foods</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/ISOMAP_faces.html" class="sidebar-item-text sidebar-link">ISOMAP vs PCA</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">NLP</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/avatar_vader.html" class="sidebar-item-text sidebar-link">VADAR Sentiment Scores</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#libraries-and-example-data" id="toc-libraries-and-example-data" class="nav-link" data-scroll-target="#libraries-and-example-data">Libraries and Example Data</a></li>
  <li><a href="#splitting-data" id="toc-splitting-data" class="nav-link" data-scroll-target="#splitting-data">Splitting Data</a></li>
  <li><a href="#recipes" id="toc-recipes" class="nav-link" data-scroll-target="#recipes">Recipes</a>
  <ul class="collapse">
  <li><a href="#functions" id="toc-functions" class="nav-link" data-scroll-target="#functions">Functions</a>
  <ul class="collapse">
  <li><a href="#selecting-variables-within-functions" id="toc-selecting-variables-within-functions" class="nav-link" data-scroll-target="#selecting-variables-within-functions">Selecting variables within functions</a></li>
  <li><a href="#roles" id="toc-roles" class="nav-link" data-scroll-target="#roles">Roles</a></li>
  <li><a href="#imputation" id="toc-imputation" class="nav-link" data-scroll-target="#imputation">Imputation</a></li>
  <li><a href="#individual-transformations" id="toc-individual-transformations" class="nav-link" data-scroll-target="#individual-transformations">Individual Transformations</a></li>
  <li><a href="#discretization" id="toc-discretization" class="nav-link" data-scroll-target="#discretization">Discretization</a></li>
  <li><a href="#dummy-variables-and-encoding" id="toc-dummy-variables-and-encoding" class="nav-link" data-scroll-target="#dummy-variables-and-encoding">Dummy Variables and Encoding</a></li>
  <li><a href="#interactions" id="toc-interactions" class="nav-link" data-scroll-target="#interactions">Interactions</a></li>
  <li><a href="#normalization" id="toc-normalization" class="nav-link" data-scroll-target="#normalization">Normalization</a></li>
  <li><a href="#multivariate-transformations" id="toc-multivariate-transformations" class="nav-link" data-scroll-target="#multivariate-transformations">Multivariate Transformations</a></li>
  <li><a href="#filters" id="toc-filters" class="nav-link" data-scroll-target="#filters">Filters</a></li>
  <li><a href="#row-operations" id="toc-row-operations" class="nav-link" data-scroll-target="#row-operations">Row Operations</a></li>
  <li><a href="#other-step-functions" id="toc-other-step-functions" class="nav-link" data-scroll-target="#other-step-functions">Other Step Functions</a></li>
  <li><a href="#check-functions" id="toc-check-functions" class="nav-link" data-scroll-target="#check-functions">Check Functions</a></li>
  <li><a href="#internal-step-handling" id="toc-internal-step-handling" class="nav-link" data-scroll-target="#internal-step-handling">Internal Step Handling</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#creating-a-workflow" id="toc-creating-a-workflow" class="nav-link" data-scroll-target="#creating-a-workflow">Creating a Workflow</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Preprocessing data in R</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ryan Keeney </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Cleaning and preprocessing data is an essential skill for data scientists. Luckily, <a href="https://www.tidymodels.org/">tidymodels</a> makes it easy and has become my go-to process for building robust and sustainable workflows.</p>
<p>My favorite advantage using this approach is that I can directly tie my preprocessing steps into my model. No more building and rebuilding preprocessing and modeling steps if you decide to change something on either end.</p>
<p>Learn more: <a href="https://www.tidymodels.org/start/recipes/" class="uri">https://www.tidymodels.org/start/recipes/</a></p>
</section>
<section id="libraries-and-example-data" class="level1">
<h1>Libraries and Example Data</h1>
<p>Load the tidymodels package and the mtcars data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels, <span class="at">quietly =</span> <span class="cn">TRUE</span>, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># load data, covert row name to column</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> mtcars <span class="sc">|&gt;</span> <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">'vehicle'</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(data <span class="sc">|&gt;</span> <span class="fu">sample_n</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 21%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">vehicle</th>
<th style="text-align: right;">mpg</th>
<th style="text-align: right;">cyl</th>
<th style="text-align: right;">disp</th>
<th style="text-align: right;">hp</th>
<th style="text-align: right;">drat</th>
<th style="text-align: right;">wt</th>
<th style="text-align: right;">qsec</th>
<th style="text-align: right;">vs</th>
<th style="text-align: right;">am</th>
<th style="text-align: right;">gear</th>
<th style="text-align: right;">carb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Merc 240D</td>
<td style="text-align: right;">24.4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">146.7</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">3.69</td>
<td style="text-align: right;">3.19</td>
<td style="text-align: right;">20.0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">Maserati Bora</td>
<td style="text-align: right;">15.0</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">301.0</td>
<td style="text-align: right;">335</td>
<td style="text-align: right;">3.54</td>
<td style="text-align: right;">3.57</td>
<td style="text-align: right;">14.6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ferrari Dino</td>
<td style="text-align: right;">19.7</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">145.0</td>
<td style="text-align: right;">175</td>
<td style="text-align: right;">3.62</td>
<td style="text-align: right;">2.77</td>
<td style="text-align: right;">15.5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="splitting-data" class="level1">
<h1>Splitting Data</h1>
<p>If you take one thing away from this post, it’ll likely be the these three functions. Splitting data (with built in methods for controlling breaks and strata) is simple with tidymodels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for replication</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1212022</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Put 3/4 of the data into the training set </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data, <span class="at">prop =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">strata =</span> cyl)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frames for the two sets:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: rsample can be used to set up cross validation, bootstrap resampling, and more. See <a href="https://www.tidymodels.org/tags/rsample/" class="uri">https://www.tidymodels.org/tags/rsample/</a> for examples.</p>
</section>
<section id="recipes" class="level1">
<h1>Recipes</h1>
<p><strong>Basic Functions:</strong></p>
<ul>
<li><p><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe()</a> Create a recipe for preprocessing data</p></li>
<li><p><a href="https://recipes.tidymodels.org/reference/formula.recipe.html">formula(<em>&lt;recipe&gt;</em>)</a> Create a Formula from a Prepared Recipe</p></li>
<li><p><a href="https://recipes.tidymodels.org/reference/print.recipe.html">print(<em>&lt;recipe&gt;</em>)</a> Print a Recipe</p></li>
<li><p><a href="https://recipes.tidymodels.org/reference/summary.recipe.html">summary(<em>&lt;recipe&gt;</em>)</a> Summarize a recipe</p></li>
<li><p><a href="https://recipes.tidymodels.org/reference/prep.html">prep()</a> Estimate (e.g., “fit,”train”) a preprocessing recipe</p></li>
<li><p><a href="https://recipes.tidymodels.org/reference/bake.html">bake()</a> Apply a trained preprocessing recipe</p></li>
</ul>
<p>Some preprocessing steps require you to “fit” or “trained” on data before it can applied to new data. If you are familiar with sklearn.preprocessing functions in <strong>Python</strong>, then these concepts might confuse you in name only - the same process still applies. If your goal is to eventually use the recipe as a preprocessor in modeling, it is suggested that a workflow is used instead of manually estimating a recipe with prep().</p>
<p>Let’s build a basic recipe, that references a formula &lt;mpg ~.&gt;(predict mpg using all other features) and uses the training data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>basic_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg <span class="sc">~</span>., <span class="at">data =</span> train_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recipes can be piped so that multiple step functions can be included. In fact, that’s a requirement for us here because I included the vehicle name as a feature. Let’s see what sort of functions we can apply.</p>
<section id="functions" class="level2">
<h2 class="anchored" data-anchor-id="functions">Functions</h2>
<p>For a full list of functions, please visit <a href="https://recipes.tidymodels.org/reference/index.html" class="uri">https://recipes.tidymodels.org/reference/index.html</a></p>
<section id="selecting-variables-within-functions" class="level3">
<h3 class="anchored" data-anchor-id="selecting-variables-within-functions">Selecting variables within functions</h3>
<p>The recipes package has a helpful set of methods for selecting variables within step functions. It uses dplyr like syntax, and helpers from the <a href="https://tidyselect.r-lib.org/index.html">tidyselect</a> package such as <a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with()</a> or <a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains()</a>. Additionally, you can select roles, or classes of variables.</p>
</section>
<section id="roles" class="level3">
<h3 class="anchored" data-anchor-id="roles">Roles</h3>
<p>While some roles set up during the formula process, roles can be manually altered as well. I’ll often use these functions to set up ID variables, which can be kept apart of the data, but ignored during modeling tasks. No more splitting and re-joining! Once a role is selected, you can select them in future function steps such as <a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes()</a>, <a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors()</a>, or be even more specific with selections like <a href="https://recipes.tidymodels.org/reference/has_role.html">all_integer_predictors()</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># update variable 'vehicle' to be an id variable.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>basic_recipe <span class="ot">&lt;-</span> basic_recipe <span class="sc">|&gt;</span>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>,<span class="at">new_role =</span> <span class="st">'id variable'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(basic_recipe) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: left;">type</th>
<th style="text-align: left;">role</th>
<th style="text-align: left;">source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">vehicle</td>
<td style="text-align: left;">string , unordered, nominal</td>
<td style="text-align: left;">id variable</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">cyl</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="odd">
<td style="text-align: left;">disp</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">hp</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="odd">
<td style="text-align: left;">drat</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">wt</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="odd">
<td style="text-align: left;">qsec</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">vs</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="odd">
<td style="text-align: left;">am</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">gear</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="odd">
<td style="text-align: left;">carb</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">predictor</td>
<td style="text-align: left;">original</td>
</tr>
<tr class="even">
<td style="text-align: left;">mpg</td>
<td style="text-align: left;">double , numeric</td>
<td style="text-align: left;">outcome</td>
<td style="text-align: left;">original</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="imputation" class="level3">
<h3 class="anchored" data-anchor-id="imputation">Imputation</h3>
<p>Another powerful feature of the recipes package is the imputation tools. If our data has NAs (it doesn’t) we could impute them using methods such as mean, mode, bagged trees, KNN, linear model, or even assign categories to “unknown”.</p>
<p>Let’s induce some NAs and then see how well it works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># randomly set 5 vehicle's hp to NA</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>data_missing <span class="ot">&lt;-</span> data</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>data_missing<span class="sc">$</span>hp[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), <span class="dv">5</span>)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>data_missing <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(hp)) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 27%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">vehicle</th>
<th style="text-align: right;">mpg</th>
<th style="text-align: right;">cyl</th>
<th style="text-align: right;">disp</th>
<th style="text-align: right;">hp</th>
<th style="text-align: right;">drat</th>
<th style="text-align: right;">wt</th>
<th style="text-align: right;">qsec</th>
<th style="text-align: right;">vs</th>
<th style="text-align: right;">am</th>
<th style="text-align: right;">gear</th>
<th style="text-align: right;">carb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Hornet Sportabout</td>
<td style="text-align: right;">18.7</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">360.0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">3.15</td>
<td style="text-align: right;">3.44</td>
<td style="text-align: right;">17.02</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">Merc 280</td>
<td style="text-align: right;">19.2</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">167.6</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">3.92</td>
<td style="text-align: right;">3.44</td>
<td style="text-align: right;">18.30</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cadillac Fleetwood</td>
<td style="text-align: right;">10.4</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">472.0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">2.93</td>
<td style="text-align: right;">5.25</td>
<td style="text-align: right;">17.98</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fiat 128</td>
<td style="text-align: right;">32.4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">78.7</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4.08</td>
<td style="text-align: right;">2.20</td>
<td style="text-align: right;">19.47</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ferrari Dino</td>
<td style="text-align: right;">19.7</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">145.0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">3.62</td>
<td style="text-align: right;">2.77</td>
<td style="text-align: right;">15.50</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create, imputation recipe and add imputation step function  </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>imputed_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg <span class="sc">~</span>., <span class="at">data =</span> train_data) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>,<span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_linear</span>(hp, <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(cyl,disp))</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># fit recipe</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>imputed_fit <span class="ot">&lt;-</span> imputed_recipe <span class="sc">|&gt;</span> <span class="fu">prep</span>(data_missing)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>imputed_fit <span class="sc">|&gt;</span> <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Recipe

Inputs:

        role #variables
 id variable          1
     outcome          1
   predictor         10

Training data contained 32 data points and 5 incomplete rows. 

Operations:

Linear regression imputation for hp [trained]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># apply recipe to the missing data</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="ot">&lt;-</span> <span class="fu">bake</span>(<span class="at">object =</span> imputed_fit, <span class="at">new_data =</span> data_missing) <span class="sc">|&gt;</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">hp_imputed =</span> hp) <span class="sc">|&gt;</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">hp_original =</span> hp)) <span class="sc">|&gt;</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(data_missing <span class="sc">|&gt;</span> <span class="fu">select</span>(hp)) <span class="sc">|&gt;</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(hp))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="sc">|&gt;</span> <span class="fu">select</span>(vehicle,hp_imputed,hp_original) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">vehicle</th>
<th style="text-align: right;">hp_imputed</th>
<th style="text-align: right;">hp_original</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Hornet Sportabout</td>
<td style="text-align: right;">210.72734</td>
<td style="text-align: right;">175</td>
</tr>
<tr class="even">
<td style="text-align: left;">Merc 280</td>
<td style="text-align: right;">131.11972</td>
<td style="text-align: right;">123</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cadillac Fleetwood</td>
<td style="text-align: right;">233.18042</td>
<td style="text-align: right;">205</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fiat 128</td>
<td style="text-align: right;">72.26115</td>
<td style="text-align: right;">66</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ferrari Dino</td>
<td style="text-align: right;">126.58901</td>
<td style="text-align: right;">175</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot check</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(imputed_data, <span class="fu">aes</span>(<span class="at">x=</span>hp_original, <span class="at">y =</span> hp_imputed)) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">'Imputed Values'</span>, <span class="at">x=</span><span class="st">'Original'</span>,<span class="at">y=</span><span class="st">'Imputed'</span>) <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="tidymodels_recipes_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="individual-transformations" class="level3">
<h3 class="anchored" data-anchor-id="individual-transformations">Individual Transformations</h3>
<p>Individual transformations can be performed, and are especially helpful for certain models that require certain assumptions to hold. For example, sometimes it’d be nice to transform a non-normal distribution into a normal distribution, enter the <a href="https://recipes.tidymodels.org/reference/step_YeoJohnson.html">step_YeoJohnson()</a> function. Other times, there are non-linear relationships that should be adjusted, especially if the model selected expects them to be.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x=</span>hp, <span class="at">y =</span> mpg)) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span>y <span class="sc">~</span> x,<span class="at">color=</span><span class="st">'red'</span>,<span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'loess'</span>, <span class="at">formula =</span>y <span class="sc">~</span> x) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'No hp transformation'</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">log</span>(hp), <span class="at">y =</span> mpg)) <span class="sc">+</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span>y <span class="sc">~</span> x,<span class="at">color=</span><span class="st">'red'</span>,<span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'loess'</span>, <span class="at">formula =</span>y <span class="sc">~</span> x) <span class="sc">+</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Log(hp) transformation'</span>,<span class="at">y=</span><span class="st">''</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(p1, p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="tidymodels_recipes_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add log step to basic recipe</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>basic_recipe <span class="ot">&lt;-</span> basic_recipe <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(hp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Transformations of variables should be carefully considered, intentionally selected, and properly evaluated. Some methods (linear regression, PCA) require closer attention to the inputs than, say XGBoost. Quick note, <a href="#normalization">normalization</a> is covered below.</p>
</section>
<section id="discretization" class="level3">
<h3 class="anchored" data-anchor-id="discretization">Discretization</h3>
<p>You can transform continuous variables into discrete variables with these step functions. That said, you <em>really</em> need to have a good reason for doing this to predicting variables. Here are just a <a href="https://discourse.datamethods.org/t/categorizing-continuous-variables/3402">few problems</a> caused by categorizing continuous variables. If you insist on continuing, check out <a href="https://recipes.tidymodels.org/reference/step_discretize.html">step_discretize()</a> and <a href="https://recipes.tidymodels.org/reference/step_cut.html">step_cut()</a>.</p>
</section>
<section id="dummy-variables-and-encoding" class="level3">
<h3 class="anchored" data-anchor-id="dummy-variables-and-encoding">Dummy Variables and Encoding</h3>
<p>Probably the most commonly used functions from this set are <a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy()</a> and <a href="https://recipes.tidymodels.org/reference/step_date.html">step_date()</a> or <a href="https://recipes.tidymodels.org/reference/step_holiday.html">step_holiday()</a> for working with time series data. Creating dummy variables explicitly before passing the data into a model gives you additional control and also sets names that are easier to interpret, set one_hot=TRUE to make sure every category gets encoded.</p>
<p>Example of <a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy()</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># There are three cylinder sizes in the dataset</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>cyl <span class="sc">|&gt;</span> <span class="fu">unique</span>() <span class="sc">|&gt;</span> <span class="fu">sort</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4 6 8</code></pre>
</div>
</div>
<p>Without one-hot encoding</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dummies_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg <span class="sc">~</span>., <span class="at">data =</span> train_data) <span class="sc">|&gt;</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>,<span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">cyl =</span> <span class="fu">as.factor</span>(cyl)) <span class="sc">|&gt;</span> <span class="co">#individual transformation: numeric -&gt; factor</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(cyl) <span class="sc">|&gt;</span> <span class="co"># new dummy step</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(train_data) <span class="co"># fit</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the recipe to the data</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>dummies_data <span class="ot">&lt;-</span> <span class="fu">bake</span>(dummies_recipe, <span class="at">new_data=</span><span class="cn">NULL</span>) </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>dummies_data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">'cyl'</span>)) <span class="sc">|&gt;</span> <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cyl_X6" "cyl_X8"</code></pre>
</div>
</div>
<p>With one-hot encoding</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dummies_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg <span class="sc">~</span>., <span class="at">data =</span> train_data) <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>,<span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">cyl =</span> <span class="fu">as.factor</span>(cyl)) <span class="sc">|&gt;</span> <span class="co">#individual transformation: numeric -&gt; factor</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(cyl, <span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="co"># new dummy step with one hot</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(train_data) <span class="co"># fit</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the recipe to the data</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>dummies_data <span class="ot">&lt;-</span> <span class="fu">bake</span>(dummies_recipe, <span class="at">new_data=</span><span class="cn">NULL</span>) </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>dummies_data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">'cyl'</span>)) <span class="sc">|&gt;</span> <span class="fu">names</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cyl_X4" "cyl_X6" "cyl_X8"</code></pre>
</div>
</div>
</section>
<section id="interactions" class="level3">
<h3 class="anchored" data-anchor-id="interactions">Interactions</h3>
<p><a href="https://recipes.tidymodels.org/reference/step_interact.html">step_interact()</a> creates an <a href="https://www.theanalysisfactor.com/interpreting-interactions-in-regression/">interaction</a> between variables. It is primarily intended for numeric data, or categorical data that has been converted to a dummy step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>interact_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg <span class="sc">~</span>., <span class="at">data =</span> data) <span class="sc">|&gt;</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>,<span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create interaction between weight and horsepower</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> hp<span class="sc">:</span>wt) <span class="sc">|&gt;</span> </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>interact_data <span class="ot">&lt;-</span> <span class="fu">bake</span>(interact_recipe,<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>interact_data <span class="sc">|&gt;</span> <span class="fu">select</span>(hp,wt,hp_x_wt) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">hp</th>
<th style="text-align: right;">wt</th>
<th style="text-align: right;">hp_x_wt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">110</td>
<td style="text-align: right;">2.620</td>
<td style="text-align: right;">288.20</td>
</tr>
<tr class="even">
<td style="text-align: right;">110</td>
<td style="text-align: right;">2.875</td>
<td style="text-align: right;">316.25</td>
</tr>
<tr class="odd">
<td style="text-align: right;">93</td>
<td style="text-align: right;">2.320</td>
<td style="text-align: right;">215.76</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="normalization" class="level3">
<h3 class="anchored" data-anchor-id="normalization">Normalization</h3>
<p>Normalization step functions are probably the most commonly used and are often necessary for accurate modeling when using methods like PCA or regularized regression such as LASSO.</p>
<ul>
<li><p><a href="https://recipes.tidymodels.org/reference/step_center.html">step_center()</a> Centers numeric data</p></li>
<li><p><a href="https://recipes.tidymodels.org/reference/step_normalize.html">step_normalize()</a> Centers and scales numeric data (<strong>this is probably the one you want!</strong>)</p></li>
<li><p><a href="https://recipes.tidymodels.org/reference/step_range.html">step_range()</a> Scale numeric data to a specific range, helpful for converting scales 1-5 or 0-100, although sometimes <a href="https://recipes.tidymodels.org/reference/step_percentile.html">step_percentile()</a> is a better fit.</p></li>
<li><p><a href="https://recipes.tidymodels.org/reference/step_scale.html">step_scale()</a> Scale numeric data</p></li>
</ul>
<p>Since it’s common to apply normalization to all numeric variables, you can select them quickly using <a href="https://recipes.tidymodels.org/reference/has_role.html">all_numeric()</a> or <a href="https://recipes.tidymodels.org/reference/has_role.html">all_numeric_predictors()</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>normalize_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg <span class="sc">~</span>., <span class="at">data =</span> data) <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>,<span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">cyl =</span> <span class="fu">as.factor</span>(cyl)) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select the vars you want, or just grap all the numeric ones.</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>normalize_data <span class="ot">&lt;-</span> <span class="fu">bake</span>(normalize_recipe, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># notice that it skips the cyl (factor) and mpg (outcome) columns!</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>normalize_data <span class="sc">|&gt;</span> <span class="fu">select</span>(vehicle,cyl, disp,hp,mpg) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">vehicle</th>
<th style="text-align: left;">cyl</th>
<th style="text-align: right;">disp</th>
<th style="text-align: right;">hp</th>
<th style="text-align: right;">mpg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Mazda RX4</td>
<td style="text-align: left;">6</td>
<td style="text-align: right;">-0.5706198</td>
<td style="text-align: right;">-0.5350928</td>
<td style="text-align: right;">21.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mazda RX4 Wag</td>
<td style="text-align: left;">6</td>
<td style="text-align: right;">-0.5706198</td>
<td style="text-align: right;">-0.5350928</td>
<td style="text-align: right;">21.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Datsun 710</td>
<td style="text-align: left;">4</td>
<td style="text-align: right;">-0.9901821</td>
<td style="text-align: right;">-0.7830405</td>
<td style="text-align: right;">22.8</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="multivariate-transformations" class="level3">
<h3 class="anchored" data-anchor-id="multivariate-transformations">Multivariate Transformations</h3>
<p>Many different <a href="https://recipes.tidymodels.org/reference/index.html#step-functions-multivariate-transformations">multivariate transformations</a> are available, from geospatial distance functions to kernel PCA functions. Even one of my favorite algorithms, <a href="https://recipes.tidymodels.org/reference/step_isomap.html">step_isomap()</a>, is available!</p>
<p>Here’s and example using <a href="https://recipes.tidymodels.org/reference/step_pca.html">step_pca()</a>. This format is so easy, I often prefer it to more specialized packages when performing EDA or dimensional reduction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pca_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg <span class="sc">~</span>hp<span class="sc">+</span>wt<span class="sc">+</span>cyl<span class="sc">+</span>drat<span class="sc">+</span>qsec<span class="sc">+</span>vehicle, <span class="at">data =</span> data) <span class="sc">|&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># include vehicle in formula, but then set as ID to keep it.</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>, <span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">cyl =</span> <span class="fu">as.factor</span>(cyl)) <span class="sc">|&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span>  <span class="co"># necessary for PCA!</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">all_numeric_predictors</span>(),<span class="at">num_comp =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span>  <span class="co"># PCA, keep the top 2 components</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>pca_data <span class="ot">&lt;-</span> <span class="fu">bake</span>(pca_recipe, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># cylinders is not included in the PCA because it is a factor</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># mpg is not included because it is an outcome.</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>pca_data <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">cyl</th>
<th style="text-align: left;">vehicle</th>
<th style="text-align: right;">mpg</th>
<th style="text-align: right;">PC1</th>
<th style="text-align: right;">PC2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Mazda RX4</td>
<td style="text-align: right;">21.0</td>
<td style="text-align: right;">-0.6150518</td>
<td style="text-align: right;">-0.9200350</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Mazda RX4 Wag</td>
<td style="text-align: right;">21.0</td>
<td style="text-align: right;">-0.5925301</td>
<td style="text-align: right;">-0.5983580</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: left;">Datsun 710</td>
<td style="text-align: right;">22.8</td>
<td style="text-align: right;">-1.3388038</td>
<td style="text-align: right;">-0.0468172</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="filters" class="level3">
<h3 class="anchored" data-anchor-id="filters">Filters</h3>
<p>Filter step functions are a great way to ‘automate’ your modeling workflow - that is, to place all your preprocessing steps <em>within</em> your recipe. Want to remove pesky columns that have near-zero variance? <a href="https://recipes.tidymodels.org/reference/step_nzv.html">step_nzv()</a> does that. Want to control for highly correlated columns? <a href="https://recipes.tidymodels.org/reference/step_corr.html">step_corr()</a> is here to help. There are many different filters to choose from here, all are useful for ensuring your workflow can handle different scenarios.</p>
<p>Example of <a href="https://recipes.tidymodels.org/reference/step_filter_missing.html">step_filter_missing()</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create missing data</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>data_missing <span class="ot">&lt;-</span> data</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># randomly set 5 vehicle's hp to NA</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>data_missing<span class="sc">$</span>hp[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), <span class="dv">5</span>)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># randomly set 10 vehicle's wt to NA</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>data_missing<span class="sc">$</span>wt[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), <span class="dv">10</span>)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">#check</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>data_missing <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(hp) <span class="sc">|</span> <span class="fu">is.na</span>(wt)) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">vehicle</th>
<th style="text-align: right;">mpg</th>
<th style="text-align: right;">cyl</th>
<th style="text-align: right;">disp</th>
<th style="text-align: right;">hp</th>
<th style="text-align: right;">drat</th>
<th style="text-align: right;">wt</th>
<th style="text-align: right;">qsec</th>
<th style="text-align: right;">vs</th>
<th style="text-align: right;">am</th>
<th style="text-align: right;">gear</th>
<th style="text-align: right;">carb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Valiant</td>
<td style="text-align: right;">18.1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">225.0</td>
<td style="text-align: right;">105</td>
<td style="text-align: right;">2.76</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">20.22</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Merc 240D</td>
<td style="text-align: right;">24.4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">146.7</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">3.69</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Merc 230</td>
<td style="text-align: right;">22.8</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">140.8</td>
<td style="text-align: right;">95</td>
<td style="text-align: right;">3.92</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">22.90</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>filter_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg <span class="sc">~</span>hp<span class="sc">+</span>wt<span class="sc">+</span>cyl<span class="sc">+</span>vehicle, <span class="at">data =</span> data_missing) <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># include vehicle in formula, but then set as ID to keep it.</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>, <span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">cyl =</span> <span class="fu">as.factor</span>(cyl)) <span class="sc">|&gt;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove columns with more than 20% missing values</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_filter_missing</span>(<span class="fu">all_predictors</span>(),<span class="at">threshold=</span>.<span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data_missing)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># wt is removed (exceeds threshold), while hp is not</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>filter_recipe <span class="sc">|&gt;</span> <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Recipe

Inputs:

        role #variables
 id variable          1
     outcome          1
   predictor          3

Training data contained 32 data points and 11 incomplete rows. 

Operations:

Variable mutation for ~as.factor(cyl) [trained]
Missing value column filter removed wt [trained]</code></pre>
</div>
</div>
</section>
<section id="row-operations" class="level3">
<h3 class="anchored" data-anchor-id="row-operations">Row Operations</h3>
<p>Row operations are mostly extensions from dplyr with functions such as <a href="https://recipes.tidymodels.org/reference/step_filter.html">step_filter()</a> and <a href="https://recipes.tidymodels.org/reference/step_naomit.html">step_naomit()</a>. Again, the goal is to build the typical preparation and cleaning operations <em>into</em> your workflow. Expect a common input format - then make it useful/understandable.</p>
</section>
<section id="other-step-functions" class="level3">
<h3 class="anchored" data-anchor-id="other-step-functions">Other Step Functions</h3>
<p>There are a few miscellaneous step functions that doesn’t fall within the normal in the organization structure set up in. A particularly useful one is <a href="https://recipes.tidymodels.org/reference/step_rename.html">step_rename()</a> for dplyr-like renaming and <a href="https://recipes.tidymodels.org/reference/step_window.html">step_window()</a> for window functions.</p>
</section>
<section id="check-functions" class="level3">
<h3 class="anchored" data-anchor-id="check-functions">Check Functions</h3>
<p>Check functions are useful for identifying issues before progressing to more intensive steps. If the check fails, it will break the <code>bake</code> function and give an error.</p>
<p>Example of <a href="https://recipes.tidymodels.org/reference/check_missing.html">check_missing()</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reuse missing data.. as expected, gives error.</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>check_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg <span class="sc">~</span>hp<span class="sc">+</span>wt<span class="sc">+</span>cyl<span class="sc">+</span>vehicle, <span class="at">data =</span> data_missing) <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># include vehicle in formula, but then set as ID to keep it.</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>, <span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">cyl =</span> <span class="fu">as.factor</span>(cyl)) <span class="sc">|&gt;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create error if there are any missing values in the predicting values</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check_missing</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data_missing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `bake()`:
! The following columns contain missing values: `hp`, `wt`.</code></pre>
</div>
</div>
</section>
<section id="internal-step-handling" class="level3">
<h3 class="anchored" data-anchor-id="internal-step-handling">Internal Step Handling</h3>
<p>Finally, there are a few functions that help manage the naming of variables, adding steps or checks, and inspecting recipes. Two ones that I use to debug are <a href="https://recipes.tidymodels.org/reference/detect_step.html">detect_step()</a> and <a href="https://recipes.tidymodels.org/reference/fully_trained.html">fully_trained()</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>internal_recipe <span class="ot">&lt;-</span><span class="fu">recipe</span>(mpg <span class="sc">~</span>hp<span class="sc">+</span>wt<span class="sc">+</span>cyl<span class="sc">+</span>vehicle, <span class="at">data =</span> data) <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="st">'vehicle'</span>, <span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">cyl =</span> <span class="fu">as.factor</span>(cyl)) <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_BoxCox</span>(<span class="fu">all_numeric</span>())</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># is the recipe trained/fit? false</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>internal_recipe <span class="sc">|&gt;</span> <span class="fu">fully_trained</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ok, train it</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>internal_recipe <span class="ot">&lt;-</span> internal_recipe <span class="sc">|&gt;</span> <span class="fu">prep</span>(data)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># is the recipe fit? true!</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>internal_recipe <span class="sc">|&gt;</span> <span class="fu">fully_trained</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># did the recipe use step_Yeo_Johnson? false</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>internal_recipe <span class="sc">|&gt;</span> <span class="fu">detect_step</span>(<span class="st">'YeoJohnson'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># did it use step_BoxCox? true</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>internal_recipe <span class="sc">|&gt;</span> <span class="fu">detect_step</span>(<span class="st">'BoxCox'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="creating-a-workflow" class="level1">
<h1>Creating a Workflow</h1>
<p>Let’s put a entire workflow together and build a small model. But before we do that using a workflow, I want to demonstrate the advantages of a workflow that integrates a the preprocessing steps vs.&nbsp;the typical approach of preprocessing the data first, then passing it to a model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for replication</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1212022</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Put 3/4 of the data into the training set </span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data, <span class="at">prop =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">strata =</span> cyl)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frames for the two sets:</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co"># set up final recipe</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>final_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg<span class="sc">~</span>.,<span class="at">data =</span> train_data) <span class="sc">|&gt;</span> </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set some of the variables to </span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(vehicle,am,vs,gear,qsec, <span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set cyl as factor</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">cyl =</span> <span class="fu">as.factor</span>(cyl)) <span class="sc">|&gt;</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dummy step cyl</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(cyl, <span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># take log of hp</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(hp)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="co"># check recipe</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>final_recipe <span class="sc">|&gt;</span> <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Recipe

Inputs:

        role #variables
 id variable          5
     outcome          1
   predictor          6

Operations:

Variable mutation for as.factor(cyl)
Dummy variables from cyl
Log transformation on hp</code></pre>
</div>
</div>
<p>First, let’s show why using a workflow is preferred to manually using prep.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># manually train recipe</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>final_recipe <span class="ot">&lt;-</span> final_recipe <span class="sc">|&gt;</span> <span class="fu">prep</span>(train_data)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># check if trained: true</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>final_recipe <span class="sc">|&gt;</span> <span class="fu">fully_trained</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Set the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set model engine</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>lm_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">|&gt;</span> <span class="fu">set_engine</span>(<span class="st">'lm'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Normally, we’d preprocess the data and then pass it into the model training. However… this doesn’t work very well when we’re using more complicated preprocessing recipes. Notice that the model isn’t using the formula and roles used in the data, it’s just using the preprocessed data, not exactly what we intended.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prep the data </span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>data_prepped <span class="ot">&lt;-</span> <span class="fu">prep</span>(final_recipe, train_data)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the model</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>linear_reg_fit <span class="ot">&lt;-</span> <span class="fu">fit</span>(lm_model,mpg<span class="sc">~</span>.,<span class="at">data =</span> <span class="fu">juice</span>(data_prepped))</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># wait. oh no.</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>linear_reg_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parsnip model object


Call:
stats::lm(formula = mpg ~ ., data = data)

Coefficients:
               (Intercept)   vehicleCadillac Fleetwood  
                  1.52e+01                   -4.80e+00  
         vehicleCamaro Z28    vehicleChrysler Imperial  
                 -1.90e+00                   -5.00e-01  
         vehicleDatsun 710     vehicleDodge Challenger  
                  7.60e+00                    3.00e-01  
         vehicleDuster 360             vehicleFiat 128  
                 -9.00e-01                    1.72e+01  
          vehicleFiat X1-9       vehicleHornet 4 Drive  
                  1.21e+01                    6.20e+00  
  vehicleHornet Sportabout  vehicleLincoln Continental  
                  3.50e+00                   -4.80e+00  
       vehicleLotus Europa        vehicleMazda RX4 Wag  
                  1.52e+01                    5.80e+00  
           vehicleMerc 230             vehicleMerc 280  
                  7.60e+00                    4.00e+00  
          vehicleMerc 280C           vehicleMerc 450SL  
                  2.60e+00                    2.10e+00  
        vehicleMerc 450SLC        vehiclePorsche 914-2  
                  9.73e-16                    1.08e+01  
      vehicleToyota Corona              vehicleValiant  
                  6.30e+00                    2.90e+00  
         vehicleVolvo 142E                        disp  
                  6.20e+00                          NA  
                        hp                        drat  
                        NA                          NA  
                        wt                        qsec  
                        NA                          NA  
                        vs                          am  
                        NA                          NA  
                      gear                        carb  
                        NA                          NA  
                    cyl_X4                      cyl_X6  
                        NA                          NA  
                    cyl_X8  
                        NA  </code></pre>
</div>
</div>
<p>To fix this, we need to carefully monitor both our preprocessing steps and our model inputs… or we could just feed our preprocessing steps directly into our model and let that dictate what it should do (much easier).</p>
<p>We’d like the recipe to seamlessly feed into the model. To do that, we need a workflow with a our recipe and a model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up final recipe</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>final_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mpg<span class="sc">~</span>.,<span class="at">data =</span> train_data) <span class="sc">|&gt;</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set some of the variables to </span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(vehicle,am,vs,gear,qsec,drat, <span class="at">new_role =</span> <span class="st">'id variable'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set cyl as factor</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">cyl =</span> <span class="fu">as.factor</span>(cyl)) <span class="sc">|&gt;</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dummy step cyl</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(cyl, <span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># take log of hp</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(hp)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co"># set model engine</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>lm_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">|&gt;</span> <span class="fu">set_engine</span>(<span class="st">'lm'</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co"># create workflow object</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>example_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add recipe</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(final_recipe) <span class="sc">|&gt;</span> </span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add model</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_model)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare the recipe and estimate the model in a single call</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>example_workflow_fit <span class="ot">&lt;-</span> <span class="fu">fit</span>(example_workflow, <span class="at">data =</span> train_data)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co"># print model</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>example_workflow_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow [trained] ==========================================================
Preprocessor: Recipe
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
3 Recipe Steps

* step_mutate()
* step_dummy()
* step_log()

-- Model -----------------------------------------------------------------------

Call:
stats::lm(formula = ..y ~ ., data = data)

Coefficients:
(Intercept)         disp           hp           wt         carb       cyl_X4  
   65.76710      0.01709     -8.35797     -3.86068      0.80086      3.27176  
     cyl_X6       cyl_X8  
    0.41508           NA  </code></pre>
</div>
</div>
<p>Okay, our model is trained. Let’s see how it did on the test data. Not bad. Maybe a little heteroskedasticity, but a good first attempt.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># collect predictions on test data</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>data_test_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(example_workflow_fit, <span class="at">new_data =</span> test_data) <span class="sc">|&gt;</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(test_data) <span class="sc">|&gt;</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(vehicle,mpg,cyl,hp,.pred)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># print predictions</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>data_test_preds <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">vehicle</th>
<th style="text-align: right;">mpg</th>
<th style="text-align: right;">cyl</th>
<th style="text-align: right;">hp</th>
<th style="text-align: right;">.pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Mazda RX4</td>
<td style="text-align: right;">21.0</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">110</td>
<td style="text-align: right;">22.71879</td>
</tr>
<tr class="even">
<td style="text-align: left;">Merc 240D</td>
<td style="text-align: right;">24.4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">26.33785</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Merc 450SE</td>
<td style="text-align: right;">16.4</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">180</td>
<td style="text-align: right;">13.76795</td>
</tr>
<tr class="even">
<td style="text-align: left;">Honda Civic</td>
<td style="text-align: right;">30.4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">32.67503</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Toyota Corolla</td>
<td style="text-align: right;">33.9</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">29.08117</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pontiac Firebird</td>
<td style="text-align: right;">19.2</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">175</td>
<td style="text-align: right;">16.19396</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ford Pantera L</td>
<td style="text-align: right;">15.8</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">264</td>
<td style="text-align: right;">16.12766</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ferrari Dino</td>
<td style="text-align: right;">19.7</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">175</td>
<td style="text-align: right;">19.60437</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Maserati Bora</td>
<td style="text-align: right;">15.0</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">335</td>
<td style="text-align: right;">14.94153</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot check</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data_test_preds, <span class="fu">aes</span>(<span class="at">x=</span>mpg, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title=</span><span class="st">'Test Data, Estimated MPG'</span>, <span class="at">x=</span><span class="st">'Original'</span>,<span class="at">y=</span><span class="st">'Estimated'</span>) <span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="tidymodels_recipes_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rsq check</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rsq</span>(data_test_preds,mpg,.pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rsq     standard       0.869</code></pre>
</div>
</div>
<p>To learn more about workflows, visit <a href="https://workflows.tidymodels.org/" class="uri">https://workflows.tidymodels.org/</a> and check out their <a href="https://workflows.tidymodels.org/articles/extras/getting-started.html#the-test-set">getting started</a> information.</p>
<p>Once you get the hang of recipes and building simple workflows, it’s a small step into resampling, parameter optimization, and improved model evaluation - all within the tidymodels framework.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2023, Ryan Keeney</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link active" href="https://twitter.com/rbkeeney" aria-current="page">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/ryan-brent-keeney/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:keeney.ryan@gmail.com">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>